name: Deploy Docker Image from ECR to EC2 via SSM

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag'
        required: true
        default: '1.0.0'
      tag_name:
        description: 'Tag name to filter EC2 instances'
        required: true
        default: 'EC2-Main'
      container_name:
        description: 'Name for the container on EC2'
        required: true
        default: 'app'
      container_port:
        description: 'Port inside the container'
        required: true
        default: '80'
      host_port:
        description: 'Port on the host EC2'
        required: true
        default: '80'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Get EC2 Instance IDs by Tag
        id: ec2
        run: |
          INSTANCE_IDS=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=${{ github.event.inputs.tag_name }}" \
            --query "Reservations[*].Instances[*].InstanceId" \
            --output text)
          
          if [ -z "$INSTANCE_IDS" ]; then
            echo "No instances found with tag ${{ github.event.inputs.tag_name }}"
            exit 1
          fi
          
          echo "EC2_IDS=$INSTANCE_IDS" >> $GITHUB_ENV
          echo "Found instances: $INSTANCE_IDS"

      - name: Deploy Docker image via SSM
        run: |
          REGION="${{ secrets.AWS_REGION }}"
          IMAGE_TAG="${{ github.event.inputs.image_tag }}"
          INSTANCE_IDS="${{ env.EC2_IDS }}"
          CONTAINER_NAME="${{ github.event.inputs.container_name }}"
          CONTAINER_PORT="${{ github.event.inputs.container_port }}"
          HOST_PORT="${{ github.event.inputs.host_port }}"
          ECR_REPO="${{ secrets.ECR_REPOSITORY }}"

          ECR_REGISTRY="282019134684.dkr.ecr.eu-west-3.amazonaws.com"
          IMAGE="${ECR_REGISTRY}:${IMAGE_TAG}"

          COMMANDS_JSON=$(jq -n \
            --arg c1 "aws ecr get-login-password --region ${REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}" \
            --arg c2 "docker pull ${IMAGE}" \
            --arg c3 "docker stop ${CONTAINER_NAME} || true" \
            --arg c4 "docker rm ${CONTAINER_NAME} || true" \
            --arg c5 "docker run -d --restart always -p ${HOST_PORT}:${CONTAINER_PORT} --name ${CONTAINER_NAME} ${IMAGE}" \
            '$ARGS.positional')

          # Ejecutar comando SSM
          aws ssm send-command \
            --instance-ids $(echo "${INSTANCE_IDS}" | tr ' ' ' ') \
            --document-name "AWS-RunShellScript" \
            --parameters commands="${COMMANDS_JSON}" \
            --region "${REGION}" \
            --comment "Deploy ${IMAGE} to instances"
